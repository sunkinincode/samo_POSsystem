<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Pro - Universal Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }

        .view-section { display: none; }
        .view-active { display: block; }
        
        .nav-active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }

        #status-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- NAVIGATION -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-[100] px-4 py-3">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center space-x-2">
                <div class="bg-indigo-600 text-white p-2 rounded-xl shadow-lg"><i class="fas fa-bolt"></i></div>
                <span class="font-extrabold text-xl tracking-tighter">POS<span class="text-indigo-600">PRO</span></span>
            </div>
            <div id="connection-indicator" class="text-[10px] font-bold text-amber-500 uppercase flex items-center">
                <i class="fas fa-circle-notch fa-spin mr-2"></i> Connecting...
            </div>
            <div class="flex flex-wrap gap-1 bg-slate-100 p-1 rounded-2xl">
                <button onclick="router('admin')" id="nav-admin" class="nav-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all nav-active">Admin</button>
                <button onclick="router('kitchen-cocoa')" id="nav-kitchen-cocoa" class="nav-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500">Cocoa</button>
                <button onclick="router('kitchen-dessert')" id="nav-kitchen-dessert" class="nav-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500">Dessert</button>
                <button onclick="router('stats')" id="nav-stats" class="nav-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500">Stats</button>
                <button onclick="router('customer')" id="nav-customer" class="nav-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500">Customer</button>
            </div>
        </div>
    </nav>

    <!-- PAGE 1: ADMIN -->
    <section id="page-admin" class="view-section view-active p-4 md:p-8">
        <div class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Store Menu</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <button onclick="cartLogic.add('Cocoa', 30, 'Beverage')" class="p-6 border-2 border-slate-50 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50 transition text-left flex items-center space-x-4 group">
                            <div class="w-16 h-16 bg-orange-100 rounded-2xl overflow-hidden group-hover:scale-110 transition flex-shrink-0">
                                <img src="https://placehold.co/200x200?text=Cocoa" class="w-full h-full object-cover" alt="Cocoa">
                            </div>
                            <div><div class="font-bold text-slate-800">Cocoa</div><div class="text-indigo-600 font-black">30.00 ฿</div></div>
                        </button>
                        <!-- Updated price to 20 Baht -->
                        <button onclick="cartLogic.add('Thai Flour Ball', 20, 'Dessert')" class="p-6 border-2 border-slate-50 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50 transition text-left flex items-center space-x-4 group">
                            <div class="w-16 h-16 bg-emerald-100 rounded-2xl overflow-hidden group-hover:scale-110 transition flex-shrink-0">
                                <img src="https://placehold.co/200x200?text=Dessert" class="w-full h-full object-cover" alt="Thai Flour Ball">
                            </div>
                            <div><div class="font-bold text-slate-800 flex items-center">Thai Flour Ball <i class="fas fa-wheat-awn ml-2 text-xs opacity-40"></i></div><div class="text-indigo-600 font-black">20.00 ฿</div></div>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Current Draft</h2>
                    <div id="cart-list" class="space-y-4 min-h-[150px]"></div>
                    <div class="mt-8 pt-8 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="text-center md:text-left">
                            <p class="text-slate-400 text-xs font-bold uppercase">Grand Total</p>
                            <p id="total-val" class="text-6xl font-black text-slate-900">0.00 ฿</p>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button onclick="firebaseActions.createOrder('Cash')" id="btn-cash" disabled class="flex-1 px-10 py-5 bg-emerald-500 text-white rounded-2xl font-black disabled:opacity-20 transition shadow-lg shadow-emerald-100">CASH</button>
                            <button onclick="firebaseActions.createOrder('QR')" id="btn-qr" disabled class="flex-1 px-10 py-5 bg-indigo-600 text-white rounded-2xl font-black disabled:opacity-20 transition shadow-lg shadow-indigo-100">QR PAY</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-slate-900 text-white p-10 rounded-[3rem] shadow-2xl text-center">
                    <p class="text-[10px] font-black uppercase text-indigo-400 mb-4 tracking-widest">Now Serving</p>
                    <h3 id="serving-id" class="text-9xl font-black mb-10">--</h3>
                    <div class="flex gap-2">
                        <button onclick="firebaseActions.callNext()" class="flex-1 py-5 bg-indigo-600 rounded-2xl font-bold hover:bg-indigo-500 transition shadow-xl">NEXT</button>
                        <button onclick="firebaseActions.resetSystem()" class="p-5 bg-slate-800 rounded-2xl text-slate-500 transition hover:text-white"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div id="admin-queue" class="space-y-2 overflow-y-auto max-h-[500px] pr-2 custom-scrollbar"></div>
            </div>
        </div>
    </section>

    <!-- KITCHEN PAGES -->
    <section id="page-kitchen-cocoa" class="view-section p-8 max-w-4xl mx-auto min-h-screen">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-5xl font-black text-slate-800 uppercase italic flex items-center">
                <div class="w-16 h-16 bg-orange-100 rounded-2xl overflow-hidden mr-4 shadow-sm flex-shrink-0">
                    <img src="https://placehold.co/200x200?text=Cocoa" class="w-full h-full object-cover" alt="Cocoa">
                </div>
                Cocoa St.
            </h1>
            <div class="bg-orange-100 text-orange-600 px-6 py-2 rounded-2xl font-black text-2xl border border-orange-200"><span id="cocoa-count">0</span> Items</div>
        </div>
        <div id="cocoa-tasks" class="grid gap-6"></div>
    </section>

    <section id="page-kitchen-dessert" class="view-section p-8 max-w-4xl mx-auto min-h-screen">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-5xl font-black text-slate-800 uppercase italic flex items-center">
                <div class="w-16 h-16 bg-emerald-100 rounded-2xl overflow-hidden mr-4 shadow-sm flex-shrink-0">
                    <img src="https://placehold.co/200x200?text=Dessert" class="w-full h-full object-cover" alt="Dessert">
                </div>
                Dessert St.
            </h1>
            <div class="bg-emerald-100 text-emerald-600 px-6 py-2 rounded-2xl font-black text-2xl border border-emerald-200"><span id="dessert-count">0</span> Items</div>
        </div>
        <div id="dessert-tasks" class="grid gap-6"></div>
    </section>

    <!-- STATS PAGE -->
    <section id="page-stats" class="view-section p-8 max-w-6xl mx-auto">
        <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                <h2 class="text-3xl font-black text-slate-800 italic">Financial Summary</h2>
                <button onclick="firebaseActions.syncToCloud()" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-indigo-100">
                    <i class="fas fa-cloud-upload-alt mr-2"></i> Sync Google Sheets
                </button>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="p-8 bg-slate-50 rounded-[2.5rem]"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Sales</p><p id="stat-sales" class="text-4xl font-black text-slate-900">0.00</p></div>
                <div class="p-8 bg-rose-50 rounded-[2.5rem] border border-rose-100">
                    <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest mb-2">Manual Cost</p>
                    <input type="number" id="cost-input" oninput="updateStatsUI()" class="w-full bg-transparent text-4xl font-black text-rose-700 outline-none placeholder-rose-200" placeholder="0">
                </div>
                <div class="p-8 bg-indigo-600 rounded-[2.5rem] text-white shadow-xl shadow-indigo-200"><p class="text-[10px] font-black text-indigo-100 uppercase tracking-widest mb-2">Net Profit</p><p id="stat-profit" class="text-4xl font-black">0.00</p></div>
                <div class="grid gap-2">
                    <div class="p-4 bg-slate-900 text-white rounded-2xl flex justify-between items-center shadow-lg"><span class="text-[10px] font-bold text-slate-500 uppercase">Hatyai (7%)</span><span id="stat-hatyai" class="font-black text-emerald-400">0.00</span></div>
                    <div class="p-4 bg-slate-900 text-white rounded-2xl flex justify-between items-center shadow-lg"><span class="text-[10px] font-bold text-slate-500 uppercase">R'sa (93%)</span><span id="stat-rsa" class="font-black text-indigo-400">0.00</span></div>
                </div>
            </div>
            <div class="mb-8 p-6 bg-slate-50 rounded-3xl border border-dashed border-slate-300">
                <h3 class="text-xs font-black text-slate-500 uppercase mb-4">Cloud URL</h3>
                <input type="text" id="apps-script-url" class="w-full p-4 bg-white rounded-xl border border-slate-200 text-xs font-mono" placeholder="Google Apps Script Web App URL...">
            </div>
            <table class="w-full text-left">
                <thead class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b"><th class="pb-4">QueueID</th><th class="pb-4">Items</th><th class="pb-4">Payment</th><th class="pb-4 text-right">Total</th></thead>
                <tbody id="history-rows"></tbody>
            </table>
        </div>
    </section>

    <!-- CUSTOMER PAGE -->
    <section id="page-customer" class="view-section p-4 md:p-8 max-w-7xl mx-auto min-h-[90vh]">
        <div class="grid lg:grid-cols-12 gap-8 h-full">
            <div class="lg:col-span-5 flex flex-col justify-center items-center">
                <div class="w-full bg-white p-12 rounded-[4rem] shadow-2xl border border-slate-100 text-center space-y-8">
                    <div class="text-[10px] font-black tracking-[0.5em] text-indigo-400 uppercase">Live Queue Tracker</div>
                    <div class="space-y-2">
                        <p class="text-slate-400 font-bold uppercase text-xs tracking-widest">Now Calling</p>
                        <h2 id="cust-serving" class="text-9xl font-black text-indigo-600 tracking-tighter">--</h2>
                    </div>
                    <div class="pt-8 border-t border-slate-100 flex justify-center space-x-4">
                        <div class="bg-slate-50 p-6 rounded-3xl flex-1">
                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Your Queue ID</p>
                            <h3 id="cust-my-id" class="text-4xl font-black text-slate-900">--</h3>
                        </div>
                    </div>
                    <!-- New Queue Checker QR -->
                    <div class="pt-6">
                        <div class="bg-indigo-50 p-4 rounded-3xl border border-indigo-100">
                            <p class="text-[10px] font-black text-indigo-400 uppercase mb-3 tracking-widest">Scan to track on phone</p>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://sunkinincode.github.io/samo_queueChecker/" class="w-32 h-32 mx-auto rounded-xl shadow-md bg-white p-2" alt="Queue Checker QR">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Real-time Global Sync -->
            <div class="lg:col-span-7 flex flex-col justify-center">
                <div id="cust-order-detail" class="bg-white p-12 rounded-[4rem] shadow-xl border border-slate-100 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-10">
                        <h2 id="cust-section-title" class="text-3xl font-black text-slate-800">Your Items</h2>
                        <span id="cust-order-status" class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase bg-slate-100 text-slate-500">Waiting</span>
                    </div>
                    <div id="cust-msg" class="flex-1 overflow-y-auto space-y-6 custom-scrollbar">
                        <!-- Content auto-syncs here -->
                    </div>
                    <!-- Real-time QR Code: Phone 062-764-9066 -->
                    <div id="cust-qr-pay" class="hidden mt-8 pt-8 border-t text-center animate-in fade-in zoom-in duration-300">
                        <div class="inline-block p-4 bg-white border-4 border-indigo-600 rounded-[2.5rem] shadow-2xl">
                            <img id="cust-qr-img" class="w-48 h-48 bg-white" alt="Payment QR">
                        </div>
                        <p class="text-indigo-600 font-black text-xs uppercase tracking-widest mt-6">Pay via PromptPay (062-764-9066)</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast -->
    <div id="status-toast" class="px-6 py-3 bg-slate-900 text-white rounded-full text-xs font-bold shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOkFlQtgEYwaMb3GzNIrq1SAQRZxDaYZA",
            authDomain: "samo-pos.firebaseapp.com",
            projectId: "samo-pos",
            storageBucket: "samo-pos.firebasestorage.app",
            messagingSenderId: "1009000743228",
            appId: "1:1009000743228:web:b09775f7e2aec8870a1e39"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'samo-pos-instance';

        // Global state
        window.appState = {
            orders: [],
            cart: [], 
            servingId: 0,
            latestOrderId: 0, 
            currentView: 'admin',
            lastSpokenId: null,
            nextIdAvailable: 101
        };

        // --- AUTH & GLOBAL LISTENERS ---
        const init = async () => {
            try {
                await signInAnonymously(auth);
                document.getElementById('connection-indicator').innerHTML = '<i class="fas fa-circle text-emerald-500 mr-2"></i> Synced';
                
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'queue_state', 'current'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        window.appState.servingId = data.servingId || 0;
                        window.appState.nextIdAvailable = data.nextIdAvailable || 101;
                        window.appState.latestOrderId = data.latestOrderId || 0;
                        updateUI();
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'queue_state', 'current'), { servingId: 0, nextIdAvailable: 101, latestOrderId: 0 });
                    }
                });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                    const fetched = [];
                    snap.forEach(doc => fetched.push({ id: doc.id, ...doc.data() }));
                    window.appState.orders = fetched.sort((a, b) => a.orderId - b.orderId);
                    updateUI();
                });

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'cart', 'active'), (snap) => {
                    if (snap.exists()) {
                        window.appState.cart = snap.data().items || [];
                        renderCartUIOnly(); 
                        updateUI(); 
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cart', 'active'), { items: [] });
                    }
                });

            } catch (e) {
                console.error(e);
                document.getElementById('connection-indicator').innerHTML = '<i class="fas fa-exclamation-triangle text-rose-500 mr-2"></i> Error';
            }
        };

        // --- FIREBASE ACTIONS ---
        window.firebaseActions = {
            syncCart: async (items) => {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cart', 'active'), { items: items });
            },

            createOrder: async (method) => {
                if (window.appState.cart.length === 0) return;
                const tasks = [];
                window.appState.cart.forEach(c => {
                    for(let i=0; i<c.qty; i++) {
                        tasks.push({ name: c.name, custom: c.custom, detail: c.detail || "", cat: c.cat, ready: false, destroyed: false });
                    }
                });

                const total = window.appState.cart.reduce((s, i) => s + (i.price * i.qty), 0);
                const oId = window.appState.nextIdAvailable;

                const payload = {
                    orderId: oId,
                    tasks: tasks,
                    total: total,
                    method: method,
                    paid: false,
                    status: 'pending',
                    timestamp: Date.now()
                };

                await window.firebaseActions.syncCart([]); 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), payload);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'queue_state', 'current'), { 
                    nextIdAvailable: oId + 1,
                    latestOrderId: oId 
                });
                
                showToast(`Order #${oId} Created`);
            },

            markPaid: async (docId) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', docId), { paid: true });
            },

            finishTask: async (docId, tIdx) => {
                const order = window.appState.orders.find(o => o.id === docId);
                if (!order) return;
                const tasks = [...order.tasks];
                tasks[tIdx].ready = true;
                tasks[tIdx].destroyed = true;
                const allReady = tasks.every(t => t.ready);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', docId), { tasks, status: allReady ? 'ready' : 'pending' });
            },

            callNext: async () => {
                const ready = window.appState.orders
                    .filter(o => o.status === 'ready' && o.orderId > window.appState.servingId)
                    .sort((a,b) => a.orderId - b.orderId);
                
                if (ready.length > 0) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'queue_state', 'current'), { servingId: ready[0].orderId });
                } else showToast("No Ready Orders");
            },

            resetSystem: async () => {
                if (!confirm("Delete all data?")) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
                const snap = await getDocs(q);
                for (const d of snap.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', d.id));
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'queue_state', 'current'), { servingId: 0, nextIdAvailable: 101, latestOrderId: 0 });
                await window.firebaseActions.syncCart([]);
                window.appState.lastSpokenId = null;
                showToast("System Reset");
            },

            syncToCloud: async () => {
                const url = document.getElementById('apps-script-url').value;
                if (!url) return showToast("Enter URL");
                const paid = window.appState.orders.filter(o => o.paid);
                const sales = paid.reduce((s, x) => s + x.total, 0);
                const cost = parseFloat(document.getElementById('cost-input').value) || 0;
                const profit = sales - cost;
                const payload = {
                    statements: window.appState.orders.map(o => ({ id: o.orderId, desc: o.tasks.map(t => `${t.name}(${t.custom})`).join(', '), payment: o.method, total: o.total })),
                    overview: { cost, sales, profit, hatyai: profit > 0 ? (profit * 0.07).toFixed(2) : 0, rsa: profit > 0 ? (profit * 0.93).toFixed(2) : 0 }
                };
                try {
                    showToast("Syncing...");
                    await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    showToast("Success");
                } catch (e) { showToast("Error"); }
            }
        };

        const updateUI = () => {
            const s = window.appState;
            document.getElementById('serving-id').innerText = s.servingId || "--";
            
            document.getElementById('admin-queue').innerHTML = s.orders.filter(o => o.status !== 'completed').reverse().map(o => `
                <div class="bg-white p-5 rounded-3xl border flex justify-between items-center shadow-sm order-row">
                    <div><div class="font-black text-slate-900">#${o.orderId}</div><div class="text-[10px] font-bold text-slate-400 uppercase">${o.method} • ${o.total.toFixed(2)} ฿</div></div>
                    <div>${!o.paid ? `<button onclick="firebaseActions.markPaid('${o.id}')" class="px-5 py-2 bg-amber-500 text-white rounded-xl text-[10px] font-black uppercase">Verify</button>` : `<div class="text-emerald-500 text-[10px] font-black uppercase">Paid</div>`}</div>
                </div>`).join('');

            const cocoa = document.getElementById('cocoa-tasks');
            const dessert = document.getElementById('dessert-tasks');
            let cRem = 0, dRem = 0;
            cocoa.innerHTML = ""; dessert.innerHTML = "";
            s.orders.forEach(o => {
                if (!o.paid) return;
                o.tasks.forEach((t, i) => {
                    if (t.destroyed) return;
                    const html = `<div class="bg-white p-6 rounded-[2rem] border flex justify-between items-center shadow-sm">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="bg-slate-900 text-white text-[10px] font-black px-3 py-1 rounded-full">#${o.orderId}</span>
                                <span class="font-black text-xl">${t.name}</span>
                                <span class="text-[10px] font-black uppercase text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded">${t.custom}</span>
                            </div>
                            <p class="text-xs text-rose-500 font-bold italic">${t.detail ? '★ ' + t.detail : ''}</p>
                        </div>
                        <button onclick="firebaseActions.finishTask('${o.id}', ${i})" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-black text-xs uppercase hover:bg-indigo-600 transition">Ready</button>
                    </div>`;
                    if (t.cat === 'Beverage') { cocoa.innerHTML += html; cRem++; } else { dessert.innerHTML += html; dRem++; }
                });
            });
            document.getElementById('cocoa-count').innerText = cRem;
            document.getElementById('dessert-count').innerText = dRem;

            updateStatsUI();
            updateCustomerViewInternal();
        };

        const updateCustomerViewInternal = () => {
            const s = window.appState;
            document.getElementById('cust-serving').innerText = s.servingId || "--";
            
            const msgArea = document.getElementById('cust-msg');
            const statusLabel = document.getElementById('cust-order-status');
            const qrSection = document.getElementById('cust-qr-pay');
            const qrImg = document.getElementById('cust-qr-img');
            const title = document.getElementById('cust-section-title');

            const activeOrder = s.orders.find(o => o.orderId === s.latestOrderId);

            if (activeOrder) {
                title.innerText = `Order #${activeOrder.orderId}`;
                document.getElementById('cust-my-id').innerText = activeOrder.orderId;
                statusLabel.innerText = activeOrder.status === 'pending' ? "PREPARING" : "READY AT COUNTER";
                statusLabel.className = activeOrder.status === 'pending' ? "px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-amber-100 text-amber-600" : "px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-100 text-emerald-600";

                msgArea.innerHTML = `<div class="space-y-3">${activeOrder.tasks.map(t => `
                    <div class="p-4 bg-slate-50 rounded-2xl border ${t.ready ? 'border-emerald-200 bg-emerald-50' : 'border-slate-100'}">
                        <div class="flex justify-between items-center mb-1">
                            <div><p class="font-bold text-slate-800 text-sm">${t.name}</p><p class="text-[10px] font-bold text-slate-400 uppercase">${t.custom}</p></div>
                            <span class="text-[10px] font-black ${t.ready ? 'text-emerald-500' : 'text-slate-300'}">${t.ready ? 'READY' : 'WAITING'}</span>
                        </div>
                        ${t.detail ? `<p class="text-[10px] text-rose-500 font-bold italic border-t pt-1 mt-1">Note: ${t.detail}</p>` : ''}
                    </div>`).join('')}</div>`;

                if (!activeOrder.paid && activeOrder.method === 'QR') {
                    qrSection.classList.remove('hidden');
                    qrImg.src = `https://promptpay.io/0627649066/${activeOrder.total}.png`;
                } else qrSection.classList.add('hidden');

                if (s.servingId === activeOrder.orderId && s.currentView === 'customer' && s.lastSpokenId !== activeOrder.orderId) {
                    s.lastSpokenId = activeOrder.orderId;
                    const u = new SpeechSynthesisUtterance(`Order ${activeOrder.orderId}. Order ${activeOrder.orderId}. Order ${activeOrder.orderId}.`);
                    u.rate = 0.9; window.speechSynthesis.speak(u);
                }
            } 
            else if (s.cart.length > 0) {
                title.innerText = "Active Selection";
                statusLabel.innerText = "DRAFT";
                statusLabel.className = "px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-indigo-50 text-indigo-400";
                document.getElementById('cust-my-id').innerText = "--";
                const total = s.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                msgArea.innerHTML = `<div class="space-y-3">${s.cart.map(i => `
                    <div class="p-4 bg-slate-50 rounded-2xl border flex flex-col">
                        <div class="flex justify-between items-center">
                            <div><p class="font-bold">${i.name} x ${i.qty}</p><p class="text-[10px] uppercase font-bold text-slate-400">${i.custom}</p></div>
                            <span class="font-black text-slate-800">${(i.price * i.qty).toFixed(2)}</span>
                        </div>
                        ${i.detail ? `<p class="text-[10px] text-rose-500 font-bold italic mt-1 border-t pt-1">Note: ${i.detail}</p>` : ''}
                    </div>`).join('')}
                    <div class="p-6 bg-slate-900 text-white rounded-[2rem] flex justify-between items-center mt-6">
                        <span class="font-bold text-xs uppercase opacity-60">Total</span>
                        <span class="text-3xl font-black">${total.toFixed(2)} ฿</span>
                    </div></div>`;
                qrSection.classList.add('hidden');
            } 
            else {
                title.innerText = "Menu";
                statusLabel.innerText = "IDLE";
                document.getElementById('cust-my-id').innerText = "--";
                msgArea.innerHTML = `<div class="text-center py-20 opacity-30 font-bold flex flex-col items-center"><i class="fas fa-shopping-basket text-4xl mb-4 text-indigo-200"></i>Welcome! Waiting for order...</div>`;
                qrSection.classList.add('hidden');
            }
        };

        init();
    </script>

    <!-- UI INPUT HANDLERS -->
    <script>
        window.cartLogic = {
            add: (name, price, cat) => {
                const current = window.appState.cart;
                current.push({ id: Date.now() + Math.random(), name, price, cat, qty: 1, custom: name === 'Cocoa' ? 'Iced' : 'Coconut Milk', detail: "" });
                window.firebaseActions.syncCart(current);
            },
            update: (id, delta) => {
                const current = window.appState.cart;
                const item = current.find(i => i.id === id);
                if (item) {
                    item.qty += delta;
                    const next = item.qty <= 0 ? current.filter(i => i.id !== id) : current;
                    window.firebaseActions.syncCart(next);
                }
            },
            custom: (id, val) => { 
                const current = window.appState.cart;
                const item = current.find(i => i.id === id);
                if (item) { item.custom = val; window.firebaseActions.syncCart(current); }
            },
            updateDetail: (id, val) => {
                const current = window.appState.cart;
                const item = current.find(i => i.id === id);
                if (item) { item.detail = val; window.firebaseActions.syncCart(current); }
            }
        };

        function renderCartUIOnly() {
            const list = document.getElementById('cart-list');
            const cart = window.appState.cart;
            if (!cart.length) { 
                list.innerHTML = `<div class="text-center py-10 text-slate-200 font-black uppercase tracking-widest">Add items to start</div>`; 
                document.getElementById('total-val').innerText = "0.00";
                ['btn-cash', 'btn-qr'].forEach(id => document.getElementById(id).disabled = true);
                return; 
            }
            ['btn-cash', 'btn-qr'].forEach(id => document.getElementById(id).disabled = false);
            list.innerHTML = cart.map(item => `
                <div class="p-5 bg-slate-50 rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex-1">
                            <div class="font-bold text-slate-800">${item.name}</div>
                            <select onchange="window.cartLogic.custom(${item.id}, this.value)" class="text-[10px] font-black uppercase text-indigo-500 bg-transparent outline-none">
                                ${item.cat === 'Beverage' ? 
                                    `<option value="Iced" ${item.custom==='Iced'?'selected':''}>Iced</option><option value="Hot" ${item.custom==='Hot'?'selected':''}>Hot</option>` : 
                                    `<option value="Coconut Milk" ${item.custom==='Coconut Milk'?'selected':''}>Coconut Milk</option><option value="Milk" ${item.custom==='Milk'?'selected':''}>Milk</option><option value="Cocoa" ${item.custom==='Cocoa'?'selected':''}>Cocoa</option>`}
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center bg-white rounded-xl border p-1">
                                <button onclick="window.cartLogic.update(${item.id}, -1)" class="w-8 h-8 text-slate-400 hover:text-indigo-600 transition">-</button>
                                <span class="w-8 text-center font-black">${item.qty}</span>
                                <button onclick="window.cartLogic.update(${item.id}, 1)" class="w-8 h-8 text-slate-400 hover:text-indigo-600 transition">+</button>
                            </div>
                            <div class="font-black w-24 text-right">${(item.price * item.qty).toFixed(2)}</div>
                        </div>
                    </div>
                    <input type="text" value="${item.detail || ''}" onchange="window.cartLogic.updateDetail(${item.id}, this.value)" 
                           class="w-full bg-white px-4 py-2 rounded-xl text-xs text-slate-500 border border-slate-200 outline-none focus:border-indigo-400" 
                           placeholder="Extra notes (e.g. less sugar, no ice)...">
                </div>`).join('');
            document.getElementById('total-val').innerText = cart.reduce((s, i) => s + (i.price * i.qty), 0).toFixed(2);
        }

        window.updateStatsUI = () => {
            const paid = window.appState.orders.filter(o => o.paid);
            const sales = paid.reduce((s, x) => s + x.total, 0);
            const cost = parseFloat(document.getElementById('cost-input').value) || 0;
            const profit = sales - cost;
            document.getElementById('stat-sales').innerText = sales.toFixed(2);
            document.getElementById('stat-profit').innerText = profit.toFixed(2);
            document.getElementById('stat-hatyai').innerText = profit > 0 ? (profit * 0.07).toFixed(2) : "0.00";
            document.getElementById('stat-rsa').innerText = profit > 0 ? (profit * 0.93).toFixed(2) : "0.00";
            document.getElementById('history-rows').innerHTML = window.appState.orders.map(o => `
                <tr class="border-b"><td class="py-4 font-black">#${o.orderId}</td><td class="text-xs text-slate-500">${o.tasks.map(t=>t.name).join(', ')}</td><td class="text-xs font-bold text-slate-400 uppercase">${o.method}</td><td class="text-right font-black text-slate-900">${o.total.toFixed(2)}</td></tr>`).join('');
        };

        window.router = (view) => {
            window.appState.currentView = view;
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('view-active'));
            document.getElementById(`page-${view}`).classList.add('view-active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active', 'text-white'));
            document.getElementById(`nav-${view}`).classList.add('nav-active');
        };

        function showToast(msg) {
            const t = document.getElementById('status-toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>